{"version":3,"sources":["../../../../src/common/runtime/helper/test_worker.ts"],"names":["LogMessageWithStack","TestWorker","constructor","debug","Map","selfPath","import","meta","url","selfPathDir","substring","lastIndexOf","workerPath","worker","Worker","type","onmessage","ev","query","data","result","logs","l","Object","setPrototypeOf","prototype","resolvers","get","run","rec","postMessage","workerResult","Promise","resolve","set","injectResult"],"mappings":";;6MAAA,SAASA,mBAAT,QAAoC,wCAApC;;AAIA,OAAO,MAAMC,UAAN,CAAiB;;;;;AAKtBC,EAAAA,WAAW,CAACC,KAAD,EAAiB,mHAFC,IAAIC,GAAJ,EAED;AAC1B,SAAKD,KAAL,GAAaA,KAAb;;AAEA,UAAME,QAAQ,GAAGC,MAAM,CAACC,IAAP,CAAYC,GAA7B;AACA,UAAMC,WAAW,GAAGJ,QAAQ,CAACK,SAAT,CAAmB,CAAnB,EAAsBL,QAAQ,CAACM,WAAT,CAAqB,GAArB,CAAtB,CAApB;AACA,UAAMC,UAAU,GAAGH,WAAW,GAAG,wBAAjC;AACA,SAAKI,MAAL,GAAc,IAAIC,MAAJ,CAAWF,UAAX,EAAuB,EAAEG,IAAI,EAAE,QAAR,EAAvB,CAAd;AACA,SAAKF,MAAL,CAAYG,SAAZ,GAAwBC,EAAE,IAAI;AAC5B,YAAMC,KAAa,GAAGD,EAAE,CAACE,IAAH,CAAQD,KAA9B;AACA,YAAME,MAAiC,GAAGH,EAAE,CAACE,IAAH,CAAQC,MAAlD;AACA,UAAIA,MAAM,CAACC,IAAX,EAAiB;AACf,aAAK,MAAMC,CAAX,IAAgBF,MAAM,CAACC,IAAvB,EAA6B;AAC3BE,UAAAA,MAAM,CAACC,cAAP,CAAsBF,CAAtB,EAAyBtB,mBAAmB,CAACyB,SAA7C;AACD;AACF;AACD,WAAKC,SAAL,CAAeC,GAAf,CAAmBT,KAAnB,EAA2BE,MAA3B;;AAEA;AACA;AACD,KAZD;AAaD;;AAED,QAAMQ,GAAN,CAAUC,GAAV,EAAiCX,KAAjC,EAA+D;AAC7D,SAAKL,MAAL,CAAYiB,WAAZ,CAAwB,EAAEZ,KAAF,EAASf,KAAK,EAAE,KAAKA,KAArB,EAAxB;AACA,UAAM4B,YAAY,GAAG,MAAM,IAAIC,OAAJ,CAAgCC,OAAO,IAAI;AACpE,WAAKP,SAAL,CAAeQ,GAAf,CAAmBhB,KAAnB,EAA0Be,OAA1B;AACD,KAF0B,CAA3B;AAGAJ,IAAAA,GAAG,CAACM,YAAJ,CAAiBJ,YAAjB;AACD,GAjCqB","sourcesContent":["import { LogMessageWithStack } from '../../framework/logging/log_message.js';\nimport { TransferredTestCaseResult, LiveTestCaseResult } from '../../framework/logging/result.js';\nimport { TestCaseRecorder } from '../../framework/logging/test_case_recorder.js';\n\nexport class TestWorker {\n  private readonly debug: boolean;\n  private readonly worker: Worker;\n  private readonly resolvers = new Map<string, (result: LiveTestCaseResult) => void>();\n\n  constructor(debug: boolean) {\n    this.debug = debug;\n\n    const selfPath = import.meta.url;\n    const selfPathDir = selfPath.substring(0, selfPath.lastIndexOf('/'));\n    const workerPath = selfPathDir + '/test_worker-worker.js';\n    this.worker = new Worker(workerPath, { type: 'module' });\n    this.worker.onmessage = ev => {\n      const query: string = ev.data.query;\n      const result: TransferredTestCaseResult = ev.data.result;\n      if (result.logs) {\n        for (const l of result.logs) {\n          Object.setPrototypeOf(l, LogMessageWithStack.prototype);\n        }\n      }\n      this.resolvers.get(query)!(result as LiveTestCaseResult);\n\n      // TODO(kainino0x): update the Logger with this result (or don't have a logger and update the\n      // entire results JSON somehow at some point).\n    };\n  }\n\n  async run(rec: TestCaseRecorder, query: string): Promise<void> {\n    this.worker.postMessage({ query, debug: this.debug });\n    const workerResult = await new Promise<LiveTestCaseResult>(resolve => {\n      this.resolvers.set(query, resolve);\n    });\n    rec.injectResult(workerResult);\n  }\n}\n"],"file":"test_worker.js"}