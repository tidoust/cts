{"version":3,"sources":["../../../../../src/webgpu/api/operation/buffers/map_detach.spec.ts"],"names":["description","makeTestGroup","GPUTest","F","checkDetach","buffer","arrayBuffer","unmap","destroy","view","Uint8Array","expect","byteLength","length","g","test","params","fn","t","device","createBuffer","size","usage","GPUBufferUsage","MAP_WRITE","mapAsync","GPUMapMode","WRITE","getMappedRange","MAP_READ","READ","desc","mappedAtCreation"],"mappings":"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","sourcesContent":["export const description = '';\n\nimport { makeTestGroup } from '../../../../common/framework/test_group.js';\nimport { GPUTest } from '../../../gpu_test.js';\n\nclass F extends GPUTest {\n  checkDetach(buffer: GPUBuffer, arrayBuffer: ArrayBuffer, unmap: boolean, destroy: boolean): void {\n    const view = new Uint8Array(arrayBuffer);\n    this.expect(arrayBuffer.byteLength === 4);\n    this.expect(view.length === 4);\n\n    if (unmap) buffer.unmap();\n    if (destroy) buffer.destroy();\n\n    this.expect(arrayBuffer.byteLength === 0, 'ArrayBuffer should be detached');\n    this.expect(view.byteLength === 0, 'ArrayBufferView should be detached');\n  }\n}\n\nexport const g = makeTestGroup(F);\n\ng.test('mapAsync,write')\n  .params([\n    { unmap: true, destroy: false }, //\n    { unmap: false, destroy: true },\n    { unmap: true, destroy: true },\n  ])\n  .fn(async t => {\n    const buffer = t.device.createBuffer({ size: 4, usage: GPUBufferUsage.MAP_WRITE });\n    await buffer.mapAsync(GPUMapMode.WRITE);\n    const arrayBuffer = buffer.getMappedRange();\n    t.checkDetach(buffer, arrayBuffer, t.params.unmap, t.params.destroy);\n  });\n\ng.test('mapAsync,read')\n  .params([\n    { unmap: true, destroy: false }, //\n    { unmap: false, destroy: true },\n    { unmap: true, destroy: true },\n  ])\n  .fn(async t => {\n    const buffer = t.device.createBuffer({ size: 4, usage: GPUBufferUsage.MAP_READ });\n    await buffer.mapAsync(GPUMapMode.READ);\n    const arrayBuffer = buffer.getMappedRange();\n    t.checkDetach(buffer, arrayBuffer, t.params.unmap, t.params.destroy);\n  });\n\ng.test('create_mapped')\n  .params([\n    { unmap: true, destroy: false },\n    { unmap: false, destroy: true },\n    { unmap: true, destroy: true },\n  ])\n  .fn(async t => {\n    const desc = {\n      mappedAtCreation: true,\n      size: 4,\n      usage: GPUBufferUsage.MAP_WRITE,\n    };\n    const buffer = t.device.createBuffer(desc);\n    const arrayBuffer = buffer.getMappedRange();\n\n    const view = new Uint8Array(arrayBuffer);\n    t.expect(arrayBuffer.byteLength === 4);\n    t.expect(view.length === 4);\n\n    if (t.params.unmap) buffer.unmap();\n    if (t.params.destroy) buffer.destroy();\n    t.expect(arrayBuffer.byteLength === 0, 'ArrayBuffer should be detached');\n    t.expect(view.byteLength === 0, 'ArrayBufferView should be detached');\n  });\n"],"file":"map_detach.spec.js"}